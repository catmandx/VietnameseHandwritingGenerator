<html>
    <head>
        <script src="/static/js/jquery-3.6.0.min.js"></script>
        <style>
            @font-face {
                font-family: HP001-Normal;
                src: url(/static/font/HP001N30.ttf);
            }
            @font-face {
                font-family: HP001-Bold;
                src: url(/static/font/HP001B30.ttf);
            }
            textarea
            {
                width:100%;
            }
            .textwrapper
            {
                border:1px solid #999999;
                margin:5px 0;
                padding:3px;
            }
            p{
                margin: 0;
            }
        </style>
        <script>
            //utils
            function getUnicodeStr(word){
                console.log(word)
                word = word.trim();
                let charArr = word.trim().split('');
                //join phu am ghep kh nh ch gh ph th
                let i = 0
                while (i < charArr.length - 1){
                    let currChar = charArr[i];
                    let nextChar = charArr[i+1];
                    if ("kh nh ch gh ph th".split(' ').indexOf(currChar+nextChar) >= 0){
                        charArr[i] = currChar+nextChar;
                        charArr.splice(i+1,1);
                    }
                    i++;
                }

                //join ooc oon
                i = 0
                while (i < charArr.length - 2){
                    let currChar = charArr[i];
                    let nextChar = charArr[i+1];
                    let nextChar2 = charArr[i+2]
                    if ("ooc oóc oọc oon".split(' ').indexOf(currChar+nextChar+nextChar2) >= 0){
                        charArr[i] = currChar+nextChar+nextChar2;
                        charArr.splice(i+1,2);
                    }
                    i++;
                }

                let baseChars = charArr.map(char => removeAccents(char.toLowerCase()));
                let unicodeString = "";
                let base = null;
                let prev = null;
                let curr = null;
                let next = null;
                for (let i = 0; i < charArr.length; i++) {
                    base = baseChars[i];
                    curr = charArr[i];
                    prev = i == 0 ? null: baseChars[i-1];
                    next = i == charArr.length - 1 ? null: baseChars[i+1];
                    let glyph = getGlyph(base, prev, curr, next);
                    console.log('glyph', glyph)
                    unicodeString += glyph;
                }
                return unicodeString;
            }

            function getGlyph(base, previous, char, next){
                console.log('getGlyph', base, previous, char, next)
                let isUppercase = isUpperCase(char);
                let accent = getAccent(char);
                if(!Object.keys(glyphs).includes(base)){return char;}
                let currentSet = glyphs[base].types;
                for (const type of currentSet) {
                    if ( type.prev.includes(previous) && type.next.includes(next) && type.isCap == isUppercase){
                        let glyphs = String(type.accent[accent]);
                        console.log(glyphs)
                        return glyphs.split(',').map(glyph => String.fromCharCode(glyph)).join('');
                    }
                }
                return char;
            }

            function getAccent(char){
                char = char.toLowerCase();
                let accentList = {
                    'acute':'áắấóốớéếíúứý',
                    'lower':'àằầòồờèềìùừỳ',
                    'rising':'ảẳẩỏổởẻểỉủửỷ',
                    'raised':'ãẵẫõỗỡẽễĩũữỹ',
                    'heavy':'ạặậọộợẹệịụựỵ',
                }
                for(const [accent, characters] of Object.entries(accentList)){
                    //special cases
                    if(/ooc/.test(char)){return "level";}
                    if(/oon/.test(char)){return "level";}
                    if(/oóc/.test(char)){return "acute";}
                    if(/oọc/.test(char)){return "heavy";}
                    //normal cases
                    var re = new RegExp('['+characters+']', 'g');
                    if(re.test(char)){
                        return accent;
                    }
                }
                return 'level';
            }
            
            function isUpperCase(str){
                if(str.length != 1){return false;};
                let uppercaseLetters = [
                    "AÀẢÃÁẠĂẰẲẴẮẶÂẦẨẪẤẬ",
                    "DĐ",
                    "EÈẺẼÉẸÊỀỂỄẾỆ",
                    "IÌỈĨÍỊ",
                    "OÒỎÕÓỌÔỒỔỖỐỘƠỜỞỠỚỢ",
                    "UÙỦŨÚỤƯỪỬỮỨỰ",
                    "YỲỶỸÝỴ",
                    "BCGHKLMNPQRSTVX"   
                ]
                for (var i=0; i<uppercaseLetters.length; i++) {
                    var re = new RegExp('[' + uppercaseLetters[i].substr(1) + ']', 'g');
                    if(re.test(str)){
                        return true;
                    }
                }
                return false;
            }
            
            function removeAccents(str) {
                // if(/ooc/.test(char) || /oọc/.test(char) || /oóc/.test(char)){return "ooc";}
                // if(/oon/.test(char)){return "oon";}
                var AccentsMap = [
                    "aàảãáạ",
                    "ăằẳẵắặ",
                    "âầẩẫấậ",
                    "AÀẢÃÁẠ",
                    "ĂẰẲẴẮẶ",
                    "ÂẦẨẪẤẬ",
                    "eèẻẽéẹ",
                    "êềểễếệ",
                    "EÈẺẼÉẸ",
                    "ÊỀỂỄẾỆ",
                    "iìỉĩíị",
                    "IÌỈĨÍỊ",
                    "oòỏõóọ",
                    "ôồổỗốộ",
                    "ơờởỡớợ",
                    "OÒỎÕÓỌ",
                    "ÔỒỔỖỐỘ",
                    "ƠỜỞỠỚỢ",
                    "uùủũúụ",
                    "ưừửữứự",
                    "UÙỦŨÚỤ",
                    "ƯỪỬỮỨỰ",
                    "yỳỷỹýỵ",
                    "YỲỶỸÝỴ"    
                ];
                for (var i=0; i<AccentsMap.length; i++) {
                    var re = new RegExp('[' + AccentsMap[i].substr(1) + ']', 'g');
                    var char = AccentsMap[i][0];
                    str = str.replace(re, char);
                }
                return str;
            }

            function stripHtml(str){
                return str.replace(/(<([^>]+)>)/gi, "");
            }
            
            function decodeHTMLEntities(text) {
                // Create a new element or use one from cache, to save some element creation overhead
                const el = decodeHTMLEntities.__cache_data_element 
                        = decodeHTMLEntities.__cache_data_element 
                        || document.createElement('div');
                
                const enc = text
                    // Prevent any mixup of existing pattern in text
                    .replace(/⪪/g, '⪪#')
                    // Encode entities in special format. This will prevent native element encoder to replace any amp characters
                    .replace(/&([a-z1-8]{2,31}|#x[0-9a-f]+|#\d+);/gi, '⪪$1⪫');

                // Encode any HTML tags in the text to prevent script injection
                el.textContent = enc;

                // Decode entities from special format, back to their original HTML entities format
                el.innerHTML = el.innerHTML
                    .replace(/⪪([a-z1-8]{2,31}|#x[0-9a-f]+|#\d+)⪫/gi, '&$1;')
                    .replace(/#⪫/g, '⪫');
            
                // Get the decoded HTML entities
                const dec = el.textContent;
                
                // Clear the element content, in order to preserve a bit of memory (it is just the text may be pretty big)
                el.textContent = '';

                return dec;
            }
        </script>
    </head>
    <body>
        <div style="display: block;" id="rulesformitem" class="formitem">
            <div class="textwrapper">
                <textarea style="font-size:72pt ;" id="input" cols="2" rows="2" id="rules"></textarea>
            </div>
        </div>
        <div id="result" style="font-size:72pt ;font-family: HP001-Bold;">
            
        </div>
        
        <script>
            //get json data
            var glyphs = {

            }
            let list = ["a", "ă", 'â', "b", 'c', 'd', 'đ', 'e', 'ê', "i", 'k', 'l', 'm', 'n','o', 'ô', 'ơ', 'r', 's','t', 'u', 'ư', 'v', 'x', 'y'
                        ,"kh"];
            $.getJSON("/data/all.json", {_: new Date().getTime()} , function(data){
                glyphs = data
                console.log(data)
            })
            //             for (const base of list) {
            //     // $.getJSON("/data/"+base+".json", function(data){
            //     //     glyphs[base] = data;
            //     // })
                
            // }
            
            console.log(glyphs)

            var $input = $('#input');
            var $result = $('#result');
            $input.on('keyup',function(e){
                //type
                let lines = $input.val().split('\n');
                let linesResult = lines.map(input => {
                    let words = input.replace(/[\s]/g," ").split(" ");
                    let result = []
                    for (const word of words) {
                        let unicodeWord = getUnicodeStr(word);
                        result.push(unicodeWord)
                    }
                    return result.join(' ');
                });
                
                $result.html("<p>"+linesResult.join("</p><p>")+"</p>")
            })
        </script>
    </body>
</html>